<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatFlow - Real-time Messaging</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #11bfff 0%, #a8dfff 100%);
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
            background: white;
            margin: 20px;
            border-radius: 16px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            overflow: hidden;
        }

        /* Authentication Screen */
        .auth-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            background: linear-gradient(135deg, #7ddcff 0%, #cef0ff 100%);
        }

        .auth-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 400px;
            text-align: center;
        }

        .auth-card h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
            font-weight: 700;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .input-group {
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #66beea 0%, #bfe8ff 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: transparent;
            color: #66b1ea;
            border: 2px solid #66bcea;
        }

        .btn-secondary:hover {
            background: #66bcea;
            color: white;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            background: linear-gradient(135deg, #2ebefc 0%, #bbebff 100%);
            color: white;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
        }

        .user-details h3 {
            margin: 0;
            font-size: 16px;
        }

        .user-status {
            font-size: 12px;
            opacity: 0.8;
        }

        .sidebar-nav {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            flex: 1;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            background: #e9ecef;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-btn.active {
            background: #66d0ea;
            color: white;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
        }

        .room-list, .user-list {
            padding: 0 20px;
        }

        .room-item, .user-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .room-item:hover, .user-item:hover {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            padding-left: 8px;
        }

        .room-item.active, .user-item.active {
            background: rgba(102, 126, 234, 0.2);
            border-radius: 8px;
            padding-left: 8px;
        }

        .room-avatar, .user-item-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #66c2ea 0%, #c0f0ff 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .room-info, .user-item-info {
            flex: 1;
        }

        .room-name, .user-item-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .room-members, .user-item-status {
            font-size: 12px;
            color: #666;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
            margin-left: auto;
        }

        .status-indicator.away {
            background: #ffc107;
        }

        .status-indicator.offline {
            background: #dc3545;
        }

        /* Main Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            background: white;
        }

        .chat-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .chat-subtitle {
            font-size: 14px;
            color: #666;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
        }

        .message.own {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #66c2ea 0%, #cff4ff 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .message.own .message-avatar {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .message-content {
            max-width: 60%;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .message.own .message-header {
            flex-direction: row-reverse;
        }

        .message-sender {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .message-time {
            font-size: 12px;
            color: #999;
        }

        .message-bubble {
            background: white;
            padding: 12px 16px;
            border-radius: 18px;
            border-top-left-radius: 4px;
            color: #333;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .message.own .message-bubble {
            background: linear-gradient(135deg, #66c9ea 0%, #c0edff 100%);
            color: white;
            border-top-left-radius: 18px;
            border-top-right-radius: 4px;
        }

        .chat-input {
            padding: 20px;
            border-top: 1px solid #e9ecef;
            background: white;
        }

        .input-container {
            display: flex;
            gap: 12px;
            align-items: end;
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 24px;
            font-size: 16px;
            resize: none;
            min-height: 48px;
            max-height: 120px;
            transition: border-color 0.3s ease;
        }

        .message-input:focus {
            outline: none;
            border-color: #66beea;
        }

        .send-btn {
            width: 48px;
            height: 48px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #66c7ea 0%, #bae8ff 100%);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .send-btn:hover {
            transform: scale(1.1);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border-left: 4px solid #66baea;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification-header {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .notification-body {
            color: #666;
            font-size: 14px;
        }

        /* Create Room Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .hidden {
            display: none !important;
        }

        .typing-indicator {
            font-style: italic;
            color: #999;
            font-size: 14px;
            padding: 8px 16px;
        }

        .connection-status {
            padding: 8px 16px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
        }

        .connection-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Authentication Screen -->
        <div class="auth-screen" id="authScreen">
            <div class="auth-card">
                <h1>ChatFlow</h1>
                <div class="auth-form">
                    <div class="input-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" placeholder="Enter your username">
                    </div>
                    <button class="btn btn-primary" onclick="login()">Join Chat</button>
                </div>
            </div>
        </div>

        <!-- Main Chat Interface -->
        <div class="hidden" id="chatInterface">
            <!-- Connection Status -->
            <div class="connection-status disconnected" id="connectionStatus">
                Connecting...
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <div class="user-details">
                            <h3 id="currentUsername">User</h3>
                            <div class="user-status">Online</div>
                        </div>
                    </div>
                </div>

                <div class="sidebar-nav">
                    <div class="nav-buttons">
                        <button class="nav-btn active" onclick="showRooms()">Rooms</button>
                        <button class="nav-btn" onclick="showUsers()">Users</button>
                    </div>
                    <button class="btn btn-primary" style="width: 100%; margin-top: 12px;" onclick="showCreateRoomModal()">
                        + Create Room
                    </button>
                </div>

                <div class="sidebar-content">
                    <div class="room-list" id="roomList">
                        <!-- Rooms will be populated here -->
                    </div>
                    <div class="user-list hidden" id="userList">
                        <!-- Users will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Main Chat Area -->
            <div class="chat-area">
                <div class="chat-header">
                    <div class="chat-title" id="chatTitle">Welcome to ChatFlow</div>
                    <div class="chat-subtitle" id="chatSubtitle">Select a room or user to start chatting</div>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <div style="text-align: center; color: #999; padding: 40px;">
                        Select a room or start a private conversation to begin chatting
                    </div>
                </div>

                <div class="typing-indicator hidden" id="typingIndicator">
                    Someone is typing...
                </div>

                <div class="chat-input">
                    <div class="input-container">
                        <textarea class="message-input" id="messageInput" placeholder="Type a message..." rows="1"></textarea>
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22,2 15,22 11,13 2,9"></polygon>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Room Modal -->
    <div class="modal hidden" id="createRoomModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Room</h3>
            </div>
            <div class="input-group">
                <label for="roomName">Room Name</label>
                <input type="text" id="roomName" placeholder="Enter room name">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideCreateRoomModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createRoom()">Create</button>
            </div>
        </div>
    </div>

    <script>
        // Application State
        let ws = null;
        let currentUser = null;
        let currentRoom = null;
        let currentPrivateChat = null;
        let rooms = [];
        let users = [];
        let messages = {};
        let typingUsers = new Set();
        let typingTimeout = null;

        // Initialize the application
        function init() {
            setupEventListeners();
        }

        function setupEventListeners() {
            // Enter key to send message
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Auto-resize textarea
            document.getElementById('messageInput').addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
            });

            // Typing indicator
            document.getElementById('messageInput').addEventListener('input', function() {
                if (currentRoom || currentPrivateChat) {
                    sendTypingIndicator();
                }
            });

            // Username input enter key
            document.getElementById('username').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });

            // Room name input enter key
            document.getElementById('roomName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    createRoom();
                }
            });
        }

        function login() {
            const username = document.getElementById('username').value.trim();
            if (!username) {
                showNotification('Error', 'Please enter a username');
                return;
            }

            currentUser = username;
            document.getElementById('currentUsername').textContent = username;
            document.getElementById('userAvatar').textContent = username.charAt(0).toUpperCase();

            // Hide auth screen and show chat interface
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('chatInterface').classList.remove('hidden');

            // Connect to WebSocket (simulated)
            connectWebSocket();
        }

        function connectWebSocket() {
            // Simulate WebSocket connection
            // In a real implementation, this would connect to a WebSocket server
            setTimeout(() => {
                document.getElementById('connectionStatus').textContent = 'Connected';
                document.getElementById('connectionStatus').classList.remove('disconnected');
                document.getElementById('connectionStatus').classList.add('connected');
                
                // Initialize with default rooms and users
                initializeDefaultData();
                showNotification('Connected', 'Successfully connected to ChatFlow');
            }, 1000);
        }

        function initializeDefaultData() {
            // Add default rooms
            rooms = [
                { id: 'general', name: 'General', members: 15 },
                { id: 'random', name: 'Random', members: 8 },
                { id: 'tech', name: 'Tech Talk', members: 23 }
            ];

            // Add default users
            users = [
                { id: 'alice', name: 'Alice', status: 'online' },
                { id: 'bob', name: 'Bob', status: 'away' },
                { id: 'charlie', name: 'Charlie', status: 'online' },
                { id: 'diana', name: 'Diana', status: 'offline' }
            ];

            // Initialize message history
            messages = {
                'general': [
                    {
                        id: 1,
                        sender: 'Alice',
                        content: 'Welcome to the general chat!',
                        timestamp: new Date(Date.now() - 300000),
                        type: 'message'
                    },
                    {
                        id: 2,
                        sender: 'Bob',
                        content: 'Hey everyone! How\'s it going?',
                        timestamp: new Date(Date.now() - 120000),
                        type: 'message'
                    }
                ],
                'tech': [
                    {
                        id: 3,
                        sender: 'Charlie',
                        content: 'Anyone working with WebSockets lately?',
                        timestamp: new Date(Date.now() - 180000),
                        type: 'message'
                    }
                ]
            };

            updateRoomList();
            updateUserList();
        }

        function showRooms() {
            document.querySelector('.nav-btn.active').classList.remove('active');
            document.querySelectorAll('.nav-btn')[0].classList.add('active');
            document.getElementById('roomList').classList.remove('hidden');
            document.getElementById('userList').classList.add('hidden');
        }

        function showUsers() {
            document.querySelector('.nav-btn.active').classList.remove('active');
            document.querySelectorAll('.nav-btn')[1].classList.add('active');
            document.getElementById('roomList').classList.add('hidden');
            document.getElementById('userList').classList.remove('hidden');
        }

        function updateRoomList() {
            const roomList = document.getElementById('roomList');
            roomList.innerHTML = '';

            rooms.forEach(room => {
                const roomElement = document.createElement('div');
                roomElement.className = 'room-item';
                roomElement.onclick = () => joinRoom(room.id);
                
                roomElement.innerHTML = `
                    <div class="room-avatar">${room.name.charAt(0)}</div>
                    <div class="room-info">
                        <div class="room-name">${room.name}</div>
                        <div class="room-members">${room.members} members</div>
                    </div>
                `;
                
                roomList.appendChild(roomElement);
            });
        }

        function updateUserList() {
            const userList = document.getElementById('userList');
            userList.innerHTML = '';

            users.forEach(user => {
                if (user.name === currentUser) return; // Don't show current user

                const userElement = document.createElement('div');
                userElement.className = 'user-item';
                userElement.onclick = () => startPrivateChat(user.id);
                
                userElement.innerHTML = `
                    <div class="user-item-avatar">${user.name.charAt(0)}</div>
                    <div class="user-item-info">
                        <div class="user-item-name">${user.name}</div>
                        <div class="user-item-status">Last seen recently</div>
                    </div>
                    <div class="status-indicator ${user.status}"></div>
                `;
                
                userList.appendChild(userElement);
            });
        }

        function joinRoom(roomId) {
            // Clear current selection
            document.querySelectorAll('.room-item.active, .user-item.active').forEach(el => {
                el.classList.remove('active');
            });

            // Set active room
            event.currentTarget.classList.add('active');
            
            currentRoom = roomId;
            currentPrivateChat = null;

            const room = rooms.find(r => r.id === roomId);
            document.getElementById('chatTitle').textContent = room.name;
            document.getElementById('chatSubtitle').textContent = `${room.members} members`;

            loadMessages(roomId);
            showNotification('Joined Room', `You joined ${room.name}`);
        }

        function startPrivateChat(userId) {
            // Clear current selection
            document.querySelectorAll('.room-item.active, .user-item.active').forEach(el => {
                el.classList.remove('active');
            });

            // Set active user
            event.currentTarget.classList.add('active');

            currentPrivateChat = userId;
            currentRoom = null;

            const user = users.find(u => u.id === userId);
            document.getElementById('chatTitle').textContent = user.name;
            document.getElementById('chatSubtitle').textContent = `Private conversation`;

            const chatKey = getPrivateChatKey(currentUser, user.name);
            loadMessages(chatKey);
            showNotification('Private Chat', `Started conversation with ${user.name}`);
        }

        function getPrivateChatKey(user1, user2) {
            return [user1, user2].sort().join('-');
        }

        function loadMessages(chatKey) {
            const messagesContainer = document.getElementById('chatMessages');
            const chatMessages = messages[chatKey] || [];

            if (chatMessages.length === 0) {
                messagesContainer.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 40px;">
                        ${currentRoom ? 'No messages yet. Start the conversation!' : 'Start your private conversation here!'}
                    </div>
                `;
                return;
            }

            messagesContainer.innerHTML = '';
            chatMessages.forEach(message => {
                addMessageToChat(message);
            });

            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addMessageToChat(message) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${message.sender === currentUser ? 'own' : ''}`;

            const time = message.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageElement.innerHTML = `
                <div class="message-avatar">${message.sender.charAt(0).toUpperCase()}</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-sender">${message.sender}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-bubble">
                        ${message.content}
                    </div>
                </div>
            `;

            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content || (!currentRoom && !currentPrivateChat)) return;

            const message = {
                id: Date.now(),
                sender: currentUser,
                content: content,
                timestamp: new Date(),
                type: 'message'
            };

            // Determine chat key
            let chatKey;
            if (currentRoom) {
                chatKey = currentRoom;
            } else {
                const targetUser = users.find(u => u.id === currentPrivateChat);
                chatKey = getPrivateChatKey(currentUser, targetUser.name);
            }

            // Add to messages
            if (!messages[chatKey]) {
                messages[chatKey] = [];
            }
            messages[chatKey].push(message);

            // Add to chat
            addMessageToChat(message);

            // Clear input
            input.value = '';
            input.style.height = 'auto';

            // Simulate receiving messages from other users
            if (Math.random() > 0.7) {
                setTimeout(() => {
                    simulateIncomingMessage(chatKey);
                }, 1000 + Math.random() * 3000);
            }
        }

        function simulateIncomingMessage(chatKey) {
            const responses = [
                "That's interesting!",
                "I agree with that.",
                "Thanks for sharing!",
                "What do you think about this?",
                "Great point!",
                "I've been thinking the same thing.",
                "Let me know if you need help with that.",
                "How's your day going?"
            ];

            let sender;
            if (currentRoom) {
                const roomUsers = ['Alice', 'Bob', 'Charlie', 'Diana'];
                sender = roomUsers[Math.floor(Math.random() * roomUsers.length)];
            } else {
                sender = users.find(u => u.id === currentPrivateChat)?.name || 'User';
            }

            if (sender === currentUser) return;

            const message = {
                id: Date.now(),
                sender: sender,
                content: responses[Math.floor(Math.random() * responses.length)],
                timestamp: new Date(),
                type: 'message'
            };

            messages[chatKey].push(message);

            // Only show if we're currently viewing this chat
            if ((currentRoom && chatKey === currentRoom) || 
                (currentPrivateChat && chatKey.includes(currentUser))) {
                addMessageToChat(message);
                
                // Show notification if user is not focused on the chat
                if (!document.hasFocus()) {
                    showNotification(`New message from ${sender}`, message.content);
                }
            }
        }

        function sendTypingIndicator() {
            // Clear existing timeout
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }

            // Show typing indicator for others (simulated)
            // In real implementation, this would send to WebSocket server
            
            // Hide typing indicator after 3 seconds of no typing
            typingTimeout = setTimeout(() => {
                // Hide typing indicator
            }, 3000);
        }

        function showCreateRoomModal() {
            document.getElementById('createRoomModal').classList.remove('hidden');
            document.getElementById('roomName').focus();
        }

        function hideCreateRoomModal() {
            document.getElementById('createRoomModal').classList.add('hidden');
            document.getElementById('roomName').value = '';
        }

        function createRoom() {
            const roomName = document.getElementById('roomName').value.trim();
            if (!roomName) {
                showNotification('Error', 'Please enter a room name');
                return;
            }

            // Check if room already exists
            if (rooms.find(r => r.name.toLowerCase() === roomName.toLowerCase())) {
                showNotification('Error', 'Room already exists');
                return;
            }

            const newRoom = {
                id: roomName.toLowerCase().replace(/\s+/g, '-'),
                name: roomName,
                members: 1
            };

            rooms.push(newRoom);
            updateRoomList();
            hideCreateRoomModal();
            
            showNotification('Room Created', `Successfully created "${roomName}"`);
            
            // Auto-join the new room
            setTimeout(() => {
                const roomElements = document.querySelectorAll('.room-item');
                const newRoomElement = Array.from(roomElements).find(el => 
                    el.querySelector('.room-name').textContent === roomName
                );
                if (newRoomElement) {
                    newRoomElement.click();
                }
            }, 100);
        }

        function showNotification(title, message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <div class="notification-header">${title}</div>
                <div class="notification-body">${message}</div>
            `;

            document.body.appendChild(notification);

            // Auto-remove after 4 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 4000);

            // Remove on click
            notification.addEventListener('click', () => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            });
        }

        // File upload functionality (simulated)
        function initFileUpload() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*,video/*,audio/*,.pdf,.doc,.docx,.txt';
            fileInput.style.display = 'none';
            document.body.appendChild(fileInput);

            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    handleFileUpload(file);
                }
            });

            // Add file upload button to chat input
            const inputContainer = document.querySelector('.input-container');
            const fileBtn = document.createElement('button');
            fileBtn.className = 'send-btn';
            fileBtn.style.marginRight = '8px';
            fileBtn.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66L9.64 16.2a2 2 0 0 1-2.83-2.83l8.49-8.49"></path>
                </svg>
            `;
            fileBtn.onclick = () => fileInput.click();
            
            inputContainer.insertBefore(fileBtn, document.getElementById('messageInput'));
        }

        function handleFileUpload(file) {
            if (!currentRoom && !currentPrivateChat) {
                showNotification('Error', 'Please select a chat to send files');
                return;
            }

            // Simulate file upload
            const fileMessage = {
                id: Date.now(),
                sender: currentUser,
                content: `📎 Shared a file: ${file.name}`,
                timestamp: new Date(),
                type: 'file',
                fileInfo: {
                    name: file.name,
                    size: file.size,
                    type: file.type
                }
            };

            // Determine chat key
            let chatKey;
            if (currentRoom) {
                chatKey = currentRoom;
            } else {
                const targetUser = users.find(u => u.id === currentPrivateChat);
                chatKey = getPrivateChatKey(currentUser, targetUser.name);
            }

            // Add to messages
            if (!messages[chatKey]) {
                messages[chatKey] = [];
            }
            messages[chatKey].push(fileMessage);

            // Add to chat
            addMessageToChat(fileMessage);

            showNotification('File Shared', `Successfully shared ${file.name}`);
        }

        // Search functionality
        function initSearch() {
            const searchInput = document.createElement('input');
            searchInput.type = 'text';
            searchInput.placeholder = 'Search messages...';
            searchInput.className = 'message-input';
            searchInput.style.marginBottom = '12px';

            const sidebarContent = document.querySelector('.sidebar-content');
            sidebarContent.insertBefore(searchInput, sidebarContent.firstChild);

            searchInput.addEventListener('input', function(e) {
                const query = e.target.value.toLowerCase();
                searchMessages(query);
            });
        }

        function searchMessages(query) {
            if (!query) return;

            const results = [];
            
            Object.keys(messages).forEach(chatKey => {
                const chatMessages = messages[chatKey];
                chatMessages.forEach(message => {
                    if (message.content.toLowerCase().includes(query)) {
                        results.push({
                            ...message,
                            chatKey: chatKey
                        });
                    }
                });
            });

            // Display search results (simplified)
            if (results.length > 0) {
                showNotification('Search Results', `Found ${results.length} messages`);
            }
        }

        // User presence simulation
        function simulateUserPresence() {
            setInterval(() => {
                users.forEach(user => {
                    if (Math.random() > 0.9) {
                        const statuses = ['online', 'away', 'offline'];
                        const currentIndex = statuses.indexOf(user.status);
                        user.status = statuses[(currentIndex + 1) % statuses.length];
                    }
                });
                updateUserList();
            }, 10000); // Update every 10 seconds
        }

        // Message reactions (simplified)
        function addReactionSupport() {
            // Add reaction functionality to messages
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.addEventListener('dblclick', function(e) {
                const messageElement = e.target.closest('.message');
                if (messageElement && !messageElement.classList.contains('own')) {
                    addReaction(messageElement);
                }
            });
        }

        function addReaction(messageElement) {
            const reactions = ['👍', '❤️', '😂', '😮', '😢', '😡'];
            const reaction = reactions[Math.floor(Math.random() * reactions.length)];
            
            let reactionContainer = messageElement.querySelector('.message-reactions');
            if (!reactionContainer) {
                reactionContainer = document.createElement('div');
                reactionContainer.className = 'message-reactions';
                reactionContainer.style.marginTop = '4px';
                messageElement.querySelector('.message-content').appendChild(reactionContainer);
            }

            const reactionSpan = document.createElement('span');
            reactionSpan.textContent = reaction;
            reactionSpan.style.fontSize = '14px';
            reactionSpan.style.marginRight = '4px';
            reactionSpan.style.padding = '2px 6px';
            reactionSpan.style.background = '#f0f0f0';
            reactionSpan.style.borderRadius = '10px';
            reactionSpan.style.cursor = 'pointer';
            
            reactionContainer.appendChild(reactionSpan);
        }

        // Message status indicators
        function addMessageStatus(messageElement, status = 'sent') {
            const statusIndicator = document.createElement('div');
            statusIndicator.className = 'message-status';
            statusIndicator.style.fontSize = '10px';
            statusIndicator.style.color = '#999';
            statusIndicator.style.textAlign = 'right';
            statusIndicator.style.marginTop = '2px';

            const statusText = {
                'sent': '✓',
                'delivered': '✓✓',
                'read': '✓✓'
            };

            statusIndicator.innerHTML = statusText[status] || '⏳';
            
            if (status === 'read') {
                statusIndicator.style.color = '#667eea';
            }

            const messageContent = messageElement.querySelector('.message-content');
            messageContent.appendChild(statusIndicator);

            // Simulate status updates
            if (status === 'sent') {
                setTimeout(() => {
                    statusIndicator.innerHTML = statusText.delivered;
                }, 1000);
                
                setTimeout(() => {
                    statusIndicator.innerHTML = statusText.read;
                    statusIndicator.style.color = '#667eea';
                }, 3000);
            }
        }

        // Enhanced message display with status
        function addMessageToChat(message) {
            const messagesContainer = document.getElementById('chatMessages');
            
            // Remove empty state message if exists
            const emptyMessage = messagesContainer.querySelector('div[style*="text-align: center"]');
            if (emptyMessage) {
                emptyMessage.remove();
            }

            const messageElement = document.createElement('div');
            messageElement.className = `message ${message.sender === currentUser ? 'own' : ''}`;

            const time = message.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageElement.innerHTML = `
                <div class="message-avatar">${message.sender.charAt(0).toUpperCase()}</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-sender">${message.sender}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-bubble">
                        ${message.content}
                    </div>
                </div>
            `;

            messagesContainer.appendChild(messageElement);

            // Add message status for own messages
            if (message.sender === currentUser) {
                addMessageStatus(messageElement, 'sent');
            }

            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Enhanced WebSocket simulation with better error handling
        function connectWebSocket() {
            // Simulate connection states
            const connectionStates = ['connecting', 'connected', 'reconnecting'];
            let currentState = 0;

            const statusElement = document.getElementById('connectionStatus');
            
            function updateConnectionStatus() {
                const state = connectionStates[currentState];
                statusElement.textContent = state.charAt(0).toUpperCase() + state.slice(1) + '...';
                
                if (state === 'connected') {
                    statusElement.classList.remove('disconnected');
                    statusElement.classList.add('connected');
                    statusElement.textContent = 'Connected';
                    
                    // Initialize data and features
                    initializeDefaultData();
                    initFileUpload();
                    initSearch();
                    simulateUserPresence();
                    addReactionSupport();
                    
                    showNotification('Connected', 'Successfully connected to ChatFlow');
                } else {
                    statusElement.classList.remove('connected');
                    statusElement.classList.add('disconnected');
                }
            }

            // Simulate connection process
            const connectionInterval = setInterval(() => {
                updateConnectionStatus();
                currentState++;
                
                if (currentState >= connectionStates.length) {
                    clearInterval(connectionInterval);
                }
            }, 800);

            // Simulate periodic reconnections
            setInterval(() => {
                if (Math.random() > 0.95) { // 5% chance every interval
                    statusElement.textContent = 'Reconnecting...';
                    statusElement.classList.remove('connected');
                    statusElement.classList.add('disconnected');
                    
                    setTimeout(() => {
                        statusElement.textContent = 'Connected';
                        statusElement.classList.remove('disconnected');
                        statusElement.classList.add('connected');
                    }, 2000);
                }
            }, 30000); // Check every 30 seconds
        }

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            init();
        });

        // Handle window focus for notifications
        let windowFocused = true;
        
        window.addEventListener('focus', () => {
            windowFocused = true;
        });
        
        window.addEventListener('blur', () => {
            windowFocused = false;
        });

        // Enhanced notification system with sound (simulated)
        function showNotification(title, message, playSound = false) {
            // Browser notification (if permission granted)
            if (!windowFocused && 'Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: message,
                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJDNi40NzcgMiAyIDYuNDc3IDIgMTJTNi40NzcgMjIgMTIgMjJTMjIgMTcuNTIzIDIyIDEyUzE3LjUyMyAyIDEyIDJaIiBmaWxsPSIjNjY3RUVBIi8+Cjx0ZXh0IHg9IjEyIiB5PSIxNiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiIGZvbnQtc2l6ZT0iMTAiIGZvbnQtd2VpZ2h0PSJib2xkIj5DPC90ZXh0Pgo8L3N2Zz4K'
                });
            }

            // In-app notification
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <div class="notification-header">${title}</div>
                <div class="notification-body">${message}</div>
            `;

            document.body.appendChild(notification);

            // Auto-remove after 4 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideIn 0.3s ease reverse';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }
            }, 4000);

            // Remove on click
            notification.addEventListener('click', () => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideIn 0.3s ease reverse';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }
            });
        }

        // Request notification permission on first user interaction
        document.addEventListener('click', function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            document.removeEventListener('click', requestNotificationPermission);
        }, { once: true });
    </script>
</body>
</html>
